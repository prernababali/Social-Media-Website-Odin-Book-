<%- include('partials/header') %>

<div class="container mt-5">

  <!-- ‚úÖ Profile picture and username -->
  <div class="d-flex align-items-center mb-4 justify-content-center">
    <% if (currentUser.imageUrl) { %>
      <img src="<%= currentUser.imageUrl %>" alt="Profile Picture" class="rounded-circle me-3" style="width: 50px; height: 50px; object-fit: cover;">
    <% } else { %>
      <img src="/images/default-avatar.png" alt="Default Avatar" class="rounded-circle me-3" style="width: 50px; height: 50px; object-fit: cover;">
    <% } %>
    <h4 class="mb-0">Welcome, <%= currentUser.username %>!</h4>
  </div>

  <!-- ‚úÖ VIEW MY PROFILE BUTTON -->
  <div class="text-center mb-3">
    <a href="/users/<%= currentUser.id %>" class="btn btn-outline-info">üë§ View My Profile</a>
  </div>

  <div class="text-center mb-4">
    <a href="/posts/new" class="btn btn-primary">Create New Post</a>
  </div>

  <div class="row">
    <!-- LEFT: Feed -->
    <div class="col-md-8">
      <h4>Feed: Your Posts + People You Follow</h4>

      <% if (posts.length === 0) { %>
        <p class="text-muted">No posts yet from you or people you follow.</p>
      <% } %>

      <!-- ‚úÖ SMALL IMAGE GRID -->
      <div class="row row-cols-2 row-cols-sm-3 row-cols-md-4 row-cols-lg-6 g-3 mb-4">
        <% posts.forEach(function(post) { %>
          <% if (post.imageUrl) { %>
            <div class="col">
              <div class="card border-0">
                <img src="<%= post.imageUrl %>" class="card-img-top" alt="Post image" style="height: 120px; object-fit: cover;">
              </div>
            </div>
          <% } %>
        <% }) %>
      </div>

      <% posts.forEach(function(post) { %>
        <div class="card-body">
          <!-- ‚úÖ Author avatar -->
          <div class="d-flex align-items-center mb-2">
            <% if (post.author.imageUrl) { %>
              <img src="<%= post.author.imageUrl %>" alt="Author Pic" class="rounded-circle me-2" style="width: 30px; height: 30px; object-fit: cover;">
            <% } else { %>
              <img src="/images/default-avatar.png" alt="Default Author Pic" class="rounded-circle me-2" style="width: 30px; height: 30px; object-fit: cover;">
            <% } %>
            <h6 class="mb-0">@<%= post.author.username %></h6>
          </div>

          <p class="card-text"><%= post.content %></p>

          <!-- Like Button -->
          <form action="/posts/<%= post.id %>/like" method="POST" style="display:inline;">
            <button type="submit" class="btn btn-sm btn-outline-primary">
              ‚ù§Ô∏è Like (<%= post.likes ? post.likes.length : 0 %>)
            </button>
          </form>

          <a href="/posts/<%= post.id %>" class="btn btn-sm btn-outline-secondary ms-2">View</a>

          <% if (post.authorId === currentUser.id) { %>
            <form action="/posts/<%= post.id %>?_method=DELETE" method="POST" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this post?');">
              <button type="submit" class="btn btn-sm btn-danger ms-2">üóëÔ∏è Delete</button>
            </form>
          <% } %>

          <!-- Comments -->
          <% if (post.comments && post.comments.length > 0) { %>
            <div class="mt-3">
              <h6>üí¨ Comments:</h6>
              <ul class="list-group">
                <% post.comments.forEach(function(comment) { %>
                  <li class="list-group-item">
                    <strong>@<%= comment.user.username %>:</strong> <%= comment.text %>
                  </li>
                <% }) %>
              </ul>
            </div>
          <% } %>

          <!-- Add Comment -->
          <form action="/posts/<%= post.id %>/comment" method="POST" class="mt-2 d-flex">
            <input type="text" name="comment" class="form-control me-2" placeholder="Write a comment..." required>
            <button type="submit" class="btn btn-sm btn-outline-success">Post</button>
          </form>
        </div>
      <% }) %>
    </div>

    <!-- RIGHT: Suggested Users -->
    <div class="col-md-4">
      <h4 class="mb-3">Suggested Users to Follow</h4>

      <% if (otherUsers.length === 0) { %>
        <p class="text-muted">No other users found.</p>
      <% } else { %>
        <ul class="list-group">
          <% otherUsers.forEach(function(user) { %>
            <li class="list-group-item d-flex flex-column align-items-start">
              <div class="d-flex justify-content-between w-100 align-items-center">
                <strong><%= user.username %></strong>
                <form action="/users/<%= user.id %>/follow" method="POST">
                  <% if (followingIds.includes(user.id)) { %>
                    <button type="submit" class="btn btn-sm btn-danger">Unfollow</button>
                  <% } else { %>
                    <button type="submit" class="btn btn-sm btn-primary">Follow</button>
                  <% } %>
                </form>
              </div>
              <!-- ‚úÖ Corrected "View Profile" for other users -->
              <a href="/users/<%= user.id %>" class="btn btn-sm btn-outline-info mt-2">View Profile</a>
            </li>
          <% }) %>
        </ul>
      <% } %>
    </div>
  </div>
</div>

<%- include('partials/footer') %>

